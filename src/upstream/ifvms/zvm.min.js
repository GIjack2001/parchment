/* ZVM v2.0.0 https://github.com/curiousdannii/ifvms.js */
(function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"==typeof window?"undefined"==typeof global?"undefined"==typeof self?this:self:global:window,t.ZVM=e()}})(function(){var e=Math.min,t=String.fromCharCode;return function p(g,e,t){function r(i,n){if(!e[i]){if(!g[i]){var o="function"==typeof require&&require;if(!n&&o)return o(i,!0);if(s)return s(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var _=e[i]={exports:{}};g[i][0].call(_.exports,function(t){var e=g[i][1][t];return r(e?e:t)},_,_.exports,p,g,e,t)}return e[i].exports}for(var s="function"==typeof require&&require,i=0;i<t.length;i++)r(t[i]);return r}({1:[function(e,t){"use strict";var s=e("../common/utils.js"),r=s.Class,i=s.U2S16,n=r.subClass({init:function(e,t){this.e=e,this.v=t},toString:function(){return this.v},U2S:function(){return i(this.v)}}),o=n.subClass({toString:function(){var e=this.v;return this.indirect?"e.indirect("+e+")":0===e?"s[--e.sp]":15>--e?"l["+e+"]":"e.m.getUint16("+(this.e.globals+2*(e-15))+")"},store:function(e){var t=this.v;return this.indirect?"e.indirect("+t+","+e+")":this.returnval?"e.variable("+t+","+e+")":0===t?"t="+e+";s[e.sp++]=t":15>--t?"l["+t+"]="+e:"e.ram.setUint16("+(this.e.globals+2*(t-15))+","+e+")"},U2S:function(){return"e.U2S("+this+")"}}),a=r.subClass({init:function(e,t,s,r,i,n){this.e=e,this.context=t,this.code=s,this.pc=r,this.labels=[this.pc+"/"+this.code],this.next=i,this.operands=n,this.post&&this.post()},toString:function(){return this.label()+(this.func?this.func.apply(this,this.operands):"")},args:function(e){return this.operands.join(e)},label:function(){return"/* "+this.labels.join()+" */ "}}),l=a.subClass({stopper:1}),p=r.subClass({init:function(e,t){this.ops=e||[],this.code=t||"||"},toString:function(){for(var e,t=0,s=[];t<this.ops.length;)e=this.ops[t++],s.push(e.func?(e.iftrue?"":"!(")+e.func.apply(e,e.operands)+(e.iftrue?"":")"):e);return(this.invert?"(!(":"(")+s.join(this.code)+(this.invert?"))":")")}}),g=a.subClass({brancher:1,keyword:"if",post:function(){var e,t,s=this.operands.pop(),r=s[1];this.iftrue=s[0],0===r||1===r?e="e.ret("+r+")":(r+=this.next-2,this.context.targets.push(r),e="e.pc="+r),this.result=e+";return",this.offset=r,this.cond=new p([this]),this.context.ops.length&&(t=this.context.ops.pop(),t.offset===r?(this.cond.ops.unshift(t.cond),this.labels=t.labels,this.labels.push(this.pc+"/"+this.code)):this.context.ops.push(t))},toString:function(){var e=this.result;return e instanceof m&&(this.e.options.debug&&(e.context=this.context),e+=e.stopper?"; return":"",1<this.result.ops.length&&(e="\n"+e+"\n",this.e.options.debug&&(e+=this.context.spacer))),this.label()+this.keyword+this.cond+" {"+e+"}"}}),_=g.subClass({storer:1,post:function(){_.super.post.call(this),this.storer=this.operands.pop(),this.storer.returnval=1,this.origfunc=this.func,this.func=this.newfunc},newfunc:function(){return this.storer.store(this.origfunc.apply(this,arguments))}}),u=a.subClass({storer:1,post:function(){this.storer=this.operands.pop()},toString:function(){var e=u.super.toString.call(this);return this.storer?this.storer.store(e):e}}),c=l.subClass({result:{v:-1},toString:function(){return this.label()+"e.call("+this.operands.shift()+","+this.result.v+","+this.next+",["+this.args()+"])"}}),d=c.subClass({storer:1,post:function(){this.result=this.operands.pop()}}),m=r.subClass({init:function(e,t){this.e=e,this.pc=t,this.pre=[],this.ops=[],this.post=[],this.targets=[],e.options.debug&&(this.spacer="")},toString:function(){return this.e.options.debug?(this.context&&(this.spacer=this.context.spacer+"  "),this.pre.join("")+(1<this.ops.length?this.spacer:"")+this.ops.join(";\n"+this.spacer)+this.post.join("")):this.pre.join("")+this.ops.join(";")+this.post.join("")}}),f=m.subClass({toString:function(){return this.pre.unshift("var l=e.l,s=e.s,t=0;\n"),f.super.toString.call(this)}});t.exports={Operand:n,Variable:o,Opcode:a,Stopper:l,BrancherLogic:p,Brancher:g,BrancherStorer:_,Storer:u,Caller:c,CallerStorer:d,Context:m,RoutineContext:f,opcode_builder:function(e,t,s){return s=s||{},t&&(s.func=t),e.subClass(s)}}},{"../common/utils.js":3}],2:[function(e,t){"use strict";var s=e("./utils.js"),r=s.MemoryView,i=s.Class.subClass({init:function(e){if(this.type="",this.chunks=[],e){var t,s,n=r(e),o=12;if("FORM"!==n.getFourCC(0))throw new Error("Not an IFF file");for(this.type=n.getFourCC(8),t=n.getUint32(4)+8;o<t;){if(s=n.getUint32(o+4),0>s||s+o>t)throw new Error("IFF chunk out of range");this.chunks.push({type:n.getFourCC(o),offset:o,data:n.getUint8Array(o+8,s)}),o+=8+s,s%2&&o++}}},write:function(){for(var e,t,s=12,n=0,i=12;n<this.chunks.length;)this.chunks[n].data.buffer&&(this.chunks[n].data=this.chunks[n].data.buffer),this.chunks[n].length=this.chunks[n].data.byteLength||this.chunks[n].data.length,s+=8+this.chunks[n++].length,s%2&&s++;for(e=r(s),e.setFourCC(0,"FORM"),e.setUint32(4,s-8),e.setFourCC(8,this.type),n=0;n<this.chunks.length;)t=this.chunks[n++],e.setFourCC(i,t.type),e.setUint32(i+4,t.length),e.setUint8Array(i+8,t.data),i+=8+t.length,i%2&&i++;return e.buffer}}),n=i.subClass({init:function(e){if(this.super.init.call(this,e),e){if("IFRS"!==this.type)throw new Error("Not a Blorb file");if("RIdx"!==this.chunks[0].type)throw new Error("Malformed Blorb: chunk 1 is not RIdx");for(var t=r(this.chunks[0].data),s=4;s<this.chunks[0].data.length;){if("Exec"===t.getFourCC(s)&&0===t.getUint32(s+4))return void(this.exec=this.chunks.filter(function(e){return e.offset===t.getUint32(s+8)})[0]);s+=12}}}}),o=i.subClass({init:function(e){if(this.super.init.call(this,e),e){if("IFZS"!==this.type)throw new Error("Not a Quetzal savefile");for(var t,s,n,o=0;o<this.chunks.length;)t=this.chunks[o].type,s=this.chunks[o++].data,"CMem"===t||"UMem"===t?(this.memory=s,this.compressed="CMem"==t):"Stks"===t?this.stacks=s:"IFhd"===t&&(n=r(s.buffer),this.release=n.getUint16(0),this.serial=n.getUint8Array(2,6),this.checksum=n.getUint16(8),this.pc=16777215&n.getUint32(9))}},write:function(){this.type="IFZS";var e=r(13);return e.setUint16(0,this.release),e.setUint8Array(2,this.serial),e.setUint32(9,this.pc),e.setUint16(8,this.checksum),this.chunks=[{type:"IFhd",data:e},{type:this.compressed?"CMem":"UMem",data:this.memory},{type:"Stks",data:this.stacks}],this.super.write.call(this)}});t.exports={IFF:i,Blorb:n,Quetzal:o,identify:function(e){var t,s,i,o=r(e);if("FORM"===o.getFourCC(0)&&"IFRS"===o.getFourCC(8)?(t=new n(e),t.exec&&(s=t.exec.type,e=t.exec.data,"GLUL"===s&&(o=r(e),i=o.getUint32(4)),"ZCOD"===s&&(i=e[0]))):"Glul"===o.getFourCC(0)?(s="GLUL",i=o.getUint32(4)):(i=o.getUint8(0),0<i&&9>i&&(s="ZCOD")),s&&i)return{format:s,version:i,data:e}}}},{"./utils.js":3}],3:[function(e,s){"use strict";function r(){for(var e,t,s=arguments[0],r=1;r<arguments.length;)for(t in e=arguments[r++],e)s[t]=e[t];return s}function i(){}function n(e){for(var t=0,s=e.length,r=new Uint16Array(s/2);t<s;)r[t/2]=e[t++]<<8|e[t++];return r}i.subClass=function(e){function t(){this.init&&this.init.apply(this,arguments)}return t.prototype=r(Object.create(this.prototype),e),t.subClass=this.subClass,t.super=t.prototype.super=this.prototype,t},s.exports={extend:r,Class:i,MemoryView:function(e,s,i){return"number"==typeof e?e=new ArrayBuffer(e):e.buffer&&(s|=0,"undefined"==typeof i&&(i=e.byteLength-s),s+=e.byteOffset,e=e.buffer),r(new DataView(e,s,i),{getUint8Array:function(e,t){return e+=this.byteOffset,new Uint8Array(this.buffer.slice(e,e+t))},getUint16Array:function(e,t){return e+=this.byteOffset,n(new Uint8Array(this.buffer,e,2*t))},setUint8Array:function(e,t){t instanceof ArrayBuffer&&(t=new Uint8Array(t)),new Uint8Array(this.buffer,this.byteOffset,this.byteLength).set(t,e)},getFourCC:function(e){return t(this.getUint8(e),this.getUint8(e+1),this.getUint8(e+2),this.getUint8(e+3))},setFourCC:function(e,t){this.setUint8(e,t.charCodeAt(0)),this.setUint8(e+1,t.charCodeAt(1)),this.setUint8(e+2,t.charCodeAt(2)),this.setUint8(e+3,t.charCodeAt(3))}})},U2S16:function(e){return e<<16>>16},S2U16:function(e){return 65535&e},Uint8toUint16Array:n}},{}],4:[function(e,t){"use strict";function s(e){const t=(e)=>"object"==typeof e?s(e):e,r={};if(Array.isArray(e))return e.map(t);for(let s in e)"buffer"!=s&&"str"!=s&&(r[s]=t(e[s]));return r}const r=e("./common/utils.js"),n=e("./common/file.js"),i={stack_len:100000,undo_len:1000000},o=r.Class.subClass(Object.assign({init:function(){this.jit={},this.init=this.start},prepare:function(e,t){if(!t.Glk)throw new Error("A reference to Glk is required");this.Glk=t.Glk,this.data=e,this.options=Object.assign({},i,t)},start:async function(){const e=n.identify(this.data);if(delete this.data,!e||"ZCOD"!==e.format)throw new Error("This is not a Z-Code file");if(0>[3,4,5,8].indexOf(e.version))throw new Error("Unsupported Z-Machine version: "+e.version);this.m=r.MemoryView(e.data),this.staticmem=this.m.getUint16(14),this.ram=r.MemoryView(this.m,0,this.staticmem),this.origram=this.m.getUint8Array(0,this.staticmem);let t="",s=0;for(;30>s;)t+=(16>this.origram[s]?"0":"")+this.origram[s++].toString(16);this.signature=t,await this.restart();const i=this.options.Dialog;if(i)if(this.options.clear_vm_autosave)i.autosave_write(t,null);else if(this.options.do_vm_autosave)try{const e=i.autosave_read(t);e&&(await this.do_autorestore(e))}catch(e){this.log("Autorestore failed, deleting it"),i.autosave_write(t,null)}this.run()},do_autosave:async function(e){if(!this.options.Dialog)throw new Error("A reference to Dialog is required");let t=null;0<=(e||0)&&(t={glk:await this.Glk.save_allstate(),io:s(this.io),ram:this.save_file(this.pc,1),read_data:s(this.read_data),xorshift_seed:this.xorshift_seed}),await this.options.Dialog.autosave_write(this.signature,t)},get_signature:function(){return this.signature}},e("./zvm/runtime.js"),e("./zvm/text.js"),e("./zvm/io.js"),e("./zvm/disassembler.js")));t.exports=o},{"./common/file.js":2,"./common/utils.js":3,"./zvm/disassembler.js":5,"./zvm/io.js":6,"./zvm/runtime.js":8,"./zvm/text.js":9}],5:[function(e,t){var s=e("../common/ast.js");t.exports.disassemble=function(){function e(e,t){for(var s=0;4>s;s++)t.push((192&e)>>6),e<<=2}for(var t,r,i,n,o,a,l,p=this.m,g=this.opcodes,_=new s.RoutineContext(this,this.pc);;){if(r=t=this.pc,n=p.getUint8(t++),190===n?(a=-1,n=p.getUint8(t++)+1e3):128&n?64&n?(a=-1,!(32&n)&&(n&=31)):(a=[(48&n)>>4],3>a[0]&&(n&=207)):(a=[64&n?2:1,32&n?2:1],n&=31),!g[n])throw this.log(""+_),this.stop=1,new Error("Unknown opcode #"+n+" at pc="+r);for(o=g[n].prototype,-1===a&&(a=[],e(p.getUint8(t++),a),(236===n||250===n)&&e(p.getUint8(t++),a)),l=[],i=0;i<a.length;)0===a[i]&&(l.push(new s.Operand(this,p.getUint16(t))),t+=2),1===a[i]&&l.push(new s.Operand(this,p.getUint8(t++))),2===a[i++]&&l.push(new s.Variable(this,p.getUint8(t++)));if(o.storer&&l.push(new s.Variable(this,p.getUint8(t++))),o.brancher&&(i=p.getUint8(t++),l.push([128&i,64&i?63&i:(i<<8|p.getUint8(t++))<<18>>18])),o.printer)for(l.push(t);t<this.eof&&(i=p.getUint8(t),t+=2,!(128&i)););if(this.pc=t,_.ops.push(new g[n](this,_,n,r,t,l)),i=0,o.stopper&&!i)break}return _}},{"../common/ast.js":1}],6:[function(s,r){"use strict";var i=s("../common/utils.js"),n=i.U2S16,o=function(){for(var e={4294967283:146,4294967284:152,4294967285:148,4294967286:154,4294967288:27,4294967289:8,4294967290:13,4294967291:130,4294967292:129,4294967293:132,4294967294:131},t=0;12>t;)e[4294967279-t]=133+t++;return e}(),a=[[0,2,1,7,4,7,5,7,9,10,6,3,6,3,6,3],[0,0,1,1,4,4,5,5,9,9,6,6,3,3,7,7]];r.exports={init_io:async function(){var e=this.Glk;this.io=this.io||{reverse:0,bold:0,italic:0,mono:2&this.m.getUint8(17),transcript:1&this.m.getUint8(17),streams:[0,1,0,[],0],currentwin:0,height:0,maxheight:0,seenheight:0,width:0,row:0,col:0},this.mainwin||(this.mainwin=await e.glk_window_open(0,0,0,3,201),e.glk_set_window(this.mainwin),this.version3&&(this.statuswin=await e.glk_window_open(this.mainwin,18,1,4,202),this.statuswin&&e.glk_set_style_stream(e.glk_window_get_stream(this.statuswin),a[1][8])))},erase_line:async function(e){if(1===e){var t=this.io,s=t.row,r=t.col;this._print(Array(t.width-t.col+1).join(" ")),await this.set_cursor(s,r)}},erase_window:async function(e){1>e&&this.Glk.glk_window_clear(this.mainwin),(1===e||-2===e)&&this.upperwin&&(this.Glk.glk_window_clear(this.upperwin),await this.set_cursor(0,0)),-1===e&&(await this.split_window(0))},fix_upper_window:async function(){var e=this.Glk,t=this.io;t.seenheight===t.maxheight&&(t.maxheight=t.height),this.upperwin&&(0===t.maxheight?(await e.glk_window_close(this.upperwin),this.upperwin=null):await e.glk_window_set_arrangement(e.glk_window_get_parent(this.upperwin),18,t.maxheight,null)),t.seenheight=t.maxheight,t.maxheight=t.height},format:function(){this.Glk.glk_set_style(a[this.io.currentwin][!!this.io.mono|this.io.italic|this.io.bold|this.io.reverse])},get_cursor:function(e){this.ram.setUint16(e,this.io.row+1),this.ram.setUint16(e+2,this.io.col+1)},input_stream:async function(e){const t=this.Glk,s=this.io.streams;if(e&&!s[0]){const e=await t.glk_fileref_create_by_prompt(259,2,212);e&&(s[0]=await t.glk_stream_open_file_uni(e,2,212),await t.glk_fileref_destroy(e))}!e&&s[0]&&(await t.glk_stream_close(s[0]),s[0]=0)},output_stream:async function(e,t){const s=this.Glk,r=this.ram,i=this.io.streams;if(e=n(e),1===e&&(i[1]=1),-1===e&&(i[1]=0),2===e&&!i[2]){const e=await s.glk_fileref_create_by_prompt(258,5,210);if(e){const t=await s.glk_stream_open_file_uni(e,5,210);i[2]=t,this.io.transcript=0|t,r.setUint8(17,254&r.getUint8(17)|!!t),await s.glk_fileref_destroy(e)}}if(-2===e&&(r.setUint8(17,254&r.getUint8(17)),i[2]&&(await s.glk_stream_close(i[2])),i[2]=this.io.transcript=0),3===e&&i[3].unshift([t,""]),-3===e){const e=i[3].shift(),t=this.text_to_zscii(e[1]);r.setUint16(e[0],t.length),r.setUint8Array(e[0]+2,t)}if(4===e&&!i[4]){const e=await s.glk_fileref_create_by_prompt(259,5,211);e&&(i[4]=await s.glk_stream_open_file_uni(e,5,211),await s.glk_fileref_destroy(e))}-4===e&&i[4]&&(await s.glk_stream_close(i[4]),i[4]=0)},_print:async function(e){var t=this.Glk,s=this.io,r=0;if(s.streams[3].length)s.streams[3][0][1]+=e;else if(e=e.replace(/\r/g,"\n"),(1&this.m.getUint8(17))!==s.transcript&&(await this.output_stream(s.transcript?-2:2)),(2&this.m.getUint8(17))!=(2&s.mono)&&(s.mono^=2,this.format()),s.currentwin&&this.upperwin)for(;r<e.length&&s.row<s.height;)t.glk_put_jstring(e[r++]),s.col++,s.col===s.width&&(s.col=0,s.row++);else s.currentwin||(s.streams[1]&&t.glk_put_jstring(e),s.streams[2]&&t.glk_put_jstring_stream(s.streams[2],e))},print:async function(e,s){var r,i;if(0===e&&(i=s),1===e&&(i=t(s)),2===e&&(i=this.jit[s]||this.decode(s)),3===e&&(r=this.m.getUint16(this.objects+(this.version3?9:14)*s+(this.version3?7:12)),i=this.decode(r+1,2*this.m.getUint8(r))),4===e){if(!this.unicode_table[s])return;i=this.unicode_table[s]}await this._print(""+i)},print_table:async function(e,t,s,r){s=s||1,r=r||0;for(let n=0;n++<s;)await this._print(this.zscii_to_text(this.m.getUint8Array(e,t))+(n<s?"\r":"")),e+=t+r},process_colours:function(){},read:async function(e,s){const r=this.Glk;let i=this.m.getUint8(e);const n=this.io.streams;this.version3&&(i++,this.v3_status());const o=Array(i);o.fill(0);let a,l;if(n[0]){let e=await r.glk_get_line_stream_uni(n[0],o);10===o[e-1]&&e--,e?(this._print(t.apply(null,o.slice(0,e))+"\n"),a=e):this.input_stream(0)}if(!a){r.glk_request_line_event_uni(this.io.currentwin?this.upperwin:this.mainwin,o,0),await this.fix_upper_window();const e=await this.glk_event(3);a=e.get_field(2),l=e.get_field(3)}const p=t.apply(null,o.slice(0,a))+"\n",g=this.text_to_zscii(p.slice(0,-1).toLowerCase());return n[2]&&r.glk_put_jstring_stream(n[2],p),n[4]&&r.glk_put_jstring_stream(n[4],p),5>this.version?(g.push(0),this.ram.setUint8Array(e+1,g)):(this.ram.setUint8(e+1,a),this.ram.setUint8Array(e+2,g)),s&&this.tokenise(e,s),isNaN(l)?13:l},read_char:async function(){const e=this.Glk,t=this.io.streams;let s;if(t[0])if(s=e.glk_get_char_stream_uni(t[0]),-1===s)this.input_stream(0);else return s;e.glk_request_char_event_uni(this.io.currentwin?this.upperwin:this.mainwin),await this.fix_upper_window();const r=await this.glk_event(2),i=r.get_field(2);return s=o[i]||this.reverse_unicode_table[i]||63,t[4]&&e.glk_put_char_stream_uni(t[4],s),s},set_colour:function(){},set_cursor:async function(e,t){var s=this.io;s.currentwin&&(e>=s.height&&(await this.split_window(e+1)),this.upperwin&&0<=e&&0<=t&&t<s.width&&(this.Glk.glk_window_move_cursor(this.upperwin,t,e),s.row=e,s.col=t))},set_font:function(e){if(1!==e&&4!==e)return 0;var t=4&this.io.mono?4:1;return e!==t&&(this.io.mono^=4,this.format()),t},set_style:function(e){var t=this.io;0===e&&(t.reverse=t.bold=t.italic=0,t.mono&=254),1&e&&(t.reverse=8),2&e&&(t.bold=4),4&e&&(t.italic=2),8&e&&(t.mono|=1),this.format()},set_true_colour:function(){},set_window:async function(e){this.io.currentwin=e,e&&(await this.set_cursor(0,0)),this.Glk.glk_set_window(this.upperwin&&e?this.upperwin:this.mainwin),this.format()},split_window:async function(e){var t,s=this.Glk,r=this.io,i=r.row,n=r.col,o=r.height;if(r.height=e,this.upperwin&&e>o){for(t=s.glk_window_get_stream(this.upperwin);o<e;)s.glk_window_move_cursor(this.upperwin,0,o++),s.glk_put_jstring_stream(t,Array(r.width+1).join(" "));s.glk_window_move_cursor(this.upperwin,n,i)}e>r.maxheight&&(r.maxheight=e,this.upperwin?await s.glk_window_set_arrangement(s.glk_window_get_parent(this.upperwin),18,r.maxheight,null):this.upperwin=await s.glk_window_open(this.mainwin,18,r.maxheight,4,203)),e&&(r.row>=e&&(await this.set_cursor(0,0)),this.version3&&s.glk_window_clear(this.upperwin))},update_header:async function(){var e=this.ram;return this.xorshift_seed=0,await this.update_screen_size(),this.version3?e.setUint8(1,64|(143&e.getUint8(1)|(this.statuswin?32:16))):void(e.setUint8(1,28),e.setUint8(17,87&e.getUint8(17)),4<this.version&&e.setUint16(38,257),e.setUint16(50,258),this.extension_table(4,0))},update_screen_size:async function(){const t=this.Glk,s=new t.RefBox,r=new t.RefBox,i=await t.glk_window_open(this.mainwin,18,0,4,0);let n=0,o=0;await t.glk_window_get_size(this.mainwin,r,s),n=s.get_value(),this.upperwin&&(await t.glk_window_get_size(this.upperwin,r,s),n+=s.get_value()),this.statuswin&&(await t.glk_window_get_size(this.statuswin,r,s),n+=s.get_value()),i&&(await t.glk_window_get_size(i,r,0),t.glk_window_close(i)),o=r.get_value(),n=e(n,254),o=this.io.width=e(o,255),3<this.version&&(this.ram.setUint8(32,n),this.ram.setUint8(33,o)),4<this.version&&(this.ram.setUint16(34,o),this.ram.setUint16(36,n)),this.io.col>=o&&(this.io.col=o-1)},v3_status:function(){if(this.statuswin){var e,t=this.Glk,s=t.glk_window_get_stream(this.statuswin),r=this.m,i=this.io.width,n=r.getUint16(this.globals+2),o=r.getUint16(this.globals+4),a=r.getUint16(this.objects+9*r.getUint16(this.globals)+7),l=""+this.decode(a+1,2*r.getUint8(a));e=2&r.getUint8(1)?"Time: "+(0==n%12?12:n%12)+":"+(10>o?"0":"")+o+" "+(11<n?"PM":"AM"):"Score: "+n+"  Turns: "+o,t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(s,Array(i+1).join(" ")),t.glk_window_move_cursor(this.statuswin,0,0),t.glk_put_jstring_stream(s," "+l.slice(0,i-e.length-4)),t.glk_window_move_cursor(this.statuswin,i-e.length-1,0),t.glk_put_jstring_stream(s,e)}}}},{"../common/utils.js":3}],7:[function(e,t){"use strict";var s=e("../common/ast.js"),r=s.Variable,i=s.Opcode,n=s.Stopper,o=s.Brancher,a=s.BrancherStorer,l=s.Storer,p=s.Caller,g=s.CallerStorer,_=s.opcode_builder,u=function(e){return""+e},c=new r(this.e,0),d=_(o,function(){return 1}),m=_(l,function(e){return"e.S2U(~"+e+")"}),f=l.subClass({storer:0,post:function(){var e=this.operands,t=e[0],s=t instanceof r;e[0]=new r(this.e,s?t:t.v),(s||0===t.v)&&(e[0].indirect=1),this.storer=142===this.code?e.pop():e.shift(),0===e.length&&e.push(c)},func:u}),U=i.subClass({func:function(e){var t=e.v-1,s=this.code%2?1:-1;return e instanceof r||14<t?"e.incdec("+e+","+s+")":(0>t?"e.s[e.sp-1]":"e.l["+t+"]")+(1==s?"++":"--")}});const h=_(l,()=>"await e.restore()"),w=_(l,()=>"await e.save()");t.exports=function(e){return{1:_(o,function(){return 2===arguments.length?this.args("==="):"e.jeq("+this.args()+")"}),2:_(o,function(e,t){return e.U2S()+"<"+t.U2S()}),3:_(o,function(e,t){return e.U2S()+">"+t.U2S()}),4:_(o,function(e,t){return"e.U2S(e.incdec("+e+",-1))<"+t.U2S()}),5:_(o,function(e,t){return"e.U2S(e.incdec("+e+",1))>"+t.U2S()}),6:_(o,function(){return"e.jin("+this.args()+")"}),7:_(o,function(){return"e.test("+this.args()+")"}),8:_(l,function(){return this.args("|")}),9:_(l,function(){return this.args("&")}),10:_(o,function(){return"e.test_attr("+this.args()+")"}),11:_(i,function(){return"e.set_attr("+this.args()+")"}),12:_(i,function(){return"e.clear_attr("+this.args()+")"}),13:f,14:_(i,function(){return"e.insert_obj("+this.args()+")"}),15:_(l,function(e,t){return"e.m.getUint16(e.S2U("+e+"+2*"+t.U2S()+"))"}),16:_(l,function(e,t){return"e.m.getUint8(e.S2U("+e+"+"+t.U2S()+"))"}),17:_(l,function(){return"e.get_prop("+this.args()+")"}),18:_(l,function(){return"e.find_prop("+this.args()+")"}),19:_(l,function(){return"e.find_prop("+this.args(",0,")+")"}),20:_(l,function(){return"e.S2U("+this.args("+")+")"}),21:_(l,function(){return"e.S2U("+this.args("-")+")"}),22:_(l,function(){return"e.S2U("+this.args("*")+")"}),23:_(l,function(e,t){return"e.S2U(parseInt("+e.U2S()+"/"+t.U2S()+"))"}),24:_(l,function(e,t){return"e.S2U("+e.U2S()+"%"+t.U2S()+")"}),25:g,26:p,27:_(i,function(){return"e.set_colour("+this.args()+")"}),28:_(n,function(e,t){return"while(e.frames.length+1>"+t+"){e.frameptr=e.frames.pop()}return "+e}),128:_(o,function(e){return e+"===0"}),129:_(a,function(e){return"e.get_sibling("+e+")"}),130:_(a,function(e){return"e.get_child("+e+")"}),131:_(l,function(e){return"e.get_parent("+e+")"}),132:_(l,function(e){return"e.get_prop_len("+e+")"}),133:U,134:U,135:_(i,(e)=>`await e.print(2,${e})`),136:g,137:_(i,function(e){return"e.remove_obj("+e+")"}),138:_(i,(e)=>`await e.print(3,${e})`),139:_(n,function(e){return"return "+e}),140:_(n,function(e){return"e.pc="+e.U2S()+"+"+(this.next-2)}),141:_(i,function(e){return`await e.print(2,${e}*${this.e.addr_multipler})`}),142:f.subClass({storer:1}),143:5>e?m:p,176:_(n,function(){return"return 1"}),177:_(n,function(){return"return 0"}),178:_(i,(e)=>`await e.print(2,${e})`,{printer:1}),179:_(n,(e)=>`await e.print(2,${e});await e.print(1,13);return 1`,{printer:1}),180:i,181:4>e?_(o,()=>"await e.save()"):w,182:4>e?_(o,()=>"await e.restore()"):h,183:_(n,function(){return"await e.erase_window(-1);await e.restart()"}),184:_(n,function(e){return"return "+e},{post:function(){this.operands.push(c)}}),185:5>e?_(i,function(){return"s[--e.sp]"}):_(l,function(){return"e.frames.length+1"}),186:_(n,function(){return"e.quit=1;await e.Glk.glk_exit()"}),187:_(i,()=>"await e.print(1,13)"),188:4>e?_(n,function(){return"e.pc="+this.next+";e.v3_status()"}):i,189:d,191:d,224:g,225:_(i,function(e,t,s){return"e.ram.setUint16(e.S2U("+e+"+2*"+t.U2S()+"),"+s+")"}),226:_(i,function(e,t,s){return"e.ram.setUint8(e.S2U("+e+"+"+t.U2S()+"),"+s+")"}),227:_(i,function(){return"e.put_prop("+this.args()+")"}),228:_(5>e?i:l,function(){return`await e.read(${this.args()})`}),229:_(i,(e)=>`await e.print(4,${e})`),230:_(i,(e)=>`await e.print(0,${e.U2S()})`),231:_(l,function(e){return"e.random("+e.U2S()+")"}),232:_(l,u,{post:function(){this.storer=c},storer:0}),233:f,234:_(i,function(e){return`await e.split_window(${e})`}),235:_(i,function(e){return`await e.set_window(${e})`}),236:g,237:_(i,function(e){return`await e.erase_window(${e.U2S()})`}),238:_(i,function(e){return`await e.erase_line(${e})`}),239:_(i,function(e,t){return"e.set_cursor("+e+"-1,"+t+"-1)"}),240:_(i,function(e){return"e.get_cursor("+e+")"}),241:_(i,function(e){return"e.set_style("+e+")"}),242:i,243:_(i,function(){return`await e.output_stream(${this.args()})`}),244:_(i,(e)=>`await e.input_stream(${e})`),245:i,246:_(l,function(){return`await e.read_char(${this.args()||"1"})`}),247:_(a,function(){return"e.scan_table("+this.args()+")"}),248:m,249:p,250:p,251:_(i,function(){return"e.tokenise("+this.args()+")"}),252:_(i,function(){return"e.encode_text("+this.args()+")"}),253:_(i,function(){return"e.copy_table("+this.args()+")"}),254:_(i,function(){return`await e.print_table(${this.args()})`}),255:_(o,function(e){return"e.stack.getUint8(e.frameptr+5)&(1<<("+e+"-1))"}),1e3:w,1001:h,1002:_(l,function(e,t){return"e.S2U(e.log_shift("+e+","+t.U2S()+"))"}),1003:_(l,function(e,t){return"e.S2U(e.art_shift("+e.U2S()+","+t.U2S()+"))"}),1004:_(l,function(e){return"e.set_font("+e+")"}),1009:_(l,function(){return"e.save_undo("+this.next+","+this.storer.v+")"}),1010:_(i,function(){return"if(e.restore_undo())return"},{storer:1}),1011:_(i,(e)=>`await e.print(1,${e})`),1012:_(l,function(){return 3}),1013:_(i,function(){return"e.set_true_colour("+this.args()+")"}),1014:i.subClass({brancher:1}),1030:_(l,function(){return"e.gestalt("+this.args()+")"})}}},{"../common/ast.js":1}],8:[function(e,t){"use strict";function s(e,t,s,r){if(p&&!r)for(;t<s;)e.setUint16(t,e.getUint16(t,1)),t+=2}const r=e("../common/file.js"),n=e("../common/utils.js"),i=n.extend,o=n.U2S16,a=n.S2U16,l=Object.getPrototypeOf(async function(){}).constructor,p=function(){var e=new Uint8Array(2),t=new Uint16Array(e.buffer);return t[0]=1,1===e[0]}();t.exports={art_shift:function(e,t){return 0<t?e<<t:e>>-t},call:function(e,t,s,r){if(0===e)return 0<=t&&this.variable(t,0),this.pc=s;this.pc=e*this.addr_multipler;var n=this.m.getUint8(this.pc++),o=this.stack,a=0,i=this.frameptr;for(o.setUint16(i+6,this.sp),this.frames.push(i),i=this.frameptr=this.s.byteOffset+2*this.sp,o.setUint32(i,s<<8),o.setUint8(i+3,(0<=t?0:16)|n),o.setUint8(i+4,0<=t?t:0),o.setUint8(i+5,(1<<r.length)-1),this.make_stacks(),this.sp=0;a<n;)this.l[a]=a<r.length?r[a]:5>this.version?this.m.getUint16(this.pc+2*a):0,a++;5>this.version&&(this.pc+=2*n)},clear_attr:function(e,t){var s=0|this.objects+(this.version3?9:14)*e+t/8;this.ram.setUint8(s,this.m.getUint8(s)&~(128>>t%8))},compile:function(){const e=this.disassemble();this.jit[e.pc]=new l("e",""+e),e.pc<this.staticmem&&this.log("Caching a JIT function in dynamic memory: "+e.pc)},copy_table:function(e,t,s){s=o(s);var r=this.ram,n=0,i=0>s;if(s=Math.abs(s),0===t){for(;n<s;)r.setUint8(e+n++,0);return}if(i)for(;n<s;)r.setUint8(t+n,this.m.getUint8(e+n++));else r.setUint8Array(t,this.m.getUint8Array(e,s))},do_autorestore:async function(e){const t=this.Glk;await t.restore_allstate(e.glk),this.io=e.io;const s=new t.RefBox;let r;for(;r=t.glk_window_iterate(r,s);)201===s.value&&(this.mainwin=r,r.linebuf&&(e.read_data.buffer=r.linebuf)),202===s.value&&(this.statuswin=r),203===s.value&&(this.upperwin=r);for(r=null;r=t.glk_stream_iterate(r,s);)210===s.value&&(this.io.streams[2]=r),211===s.value&&(this.io.streams[4]=r);await this.restore_file(new Uint8Array(e.ram),1),this.read_data=e.read_data,this.xorshift_seed=e.xorshift_seed},encode_text:function(e,t,s,r){this.ram.setUint8Array(r,this.encode(this.m.getUint8Array(e+s,t)))},extension_table:function(e,t){var s=this.extension;return!s||e>this.extension_count?0:(s+=2*e,void 0===t?this.m.getUint16(s):void this.ram.setUint16(s,t))},find_prop:function(e,t,s){var r,i,n=this.m,o=this.version3,a=0,l=n.getUint16(this.objects+(o?9:14)*e+(o?7:12));for(l+=2*n.getUint8(l)+1;;){if(r=n.getUint8(l),i=r&(o?31:63),a===s)return i;if(i===t)return l+(!o&&128&r?2:1);if(i<t)return 0;a=i,o?l+=(r>>5)+2:128&r?(i=63&n.getUint8(l+1),l+=i?i+2:66):l+=64&r?3:2}},gestalt:function(e){return 1===e?258:8192===e?1:8193===e||8194===e?2:0},get_child:function(e){return this.version3?this.m.getUint8(this.objects+9*e+6):this.m.getUint16(this.objects+14*e+10)},get_sibling:function(e){return this.version3?this.m.getUint8(this.objects+9*e+5):this.m.getUint16(this.objects+14*e+8)},get_parent:function(e){return this.version3?this.m.getUint8(this.objects+9*e+4):this.m.getUint16(this.objects+14*e+6)},get_prop:function(e,t){var s,r=this.m,i=this.find_prop(e,t);return i?(s=r.getUint8(i-1),r[(this.version3?s>>5:64&s)?"getUint16":"getUint8"](i)):r.getUint16(this.properties+2*(t-1))},get_prop_len:function(e){if(0===e)return 0;var t=this.m.getUint8(e-1);return this.version3?(t>>5)+1:128&t?(t&=63,0===t?64:t):64&t?2:1},glk_event:async function(e){for(;;){const t=new this.Glk.RefStruct;await this.Glk.glk_select(t);const s=t.get_field(0);if(5===s&&(await this.update_screen_size()),s===e)return t}},incdec:function(e,t){if(0===e)return this.s[this.sp-1]+=t,this.s[this.sp-1];if(15>--e)return this.l[e]+=t,this.l[e];var s=this.globals+2*(e-15);return this.ram.setUint16(s,this.m.getUint16(s)+t),this.ram.getUint16(s)},indirect:function(e,t){return 0===e?1<arguments.length?this.s[this.sp-1]=t:this.s[this.sp-1]:this.variable(e,t)},insert_obj:function(e,t){this.remove_obj(e),this.set_family(e,t,t,e,e,this.get_child(t))},jeq:function(){for(var e=1;e<arguments.length;)if(arguments[e++]===arguments[0])return 1},jin:function(e,t){return this.get_parent(e)===t},log:function(e){this.options.GlkOte&&this.options.GlkOte.log(e)},log_shift:function(e,t){return 0<t?e<<t:e>>>-t},make_stacks:function(){var e=15&this.stack.getUint8(this.frameptr+3);this.l=new Uint16Array(this.stack.buffer,this.frameptr+8,e),this.s=new Uint16Array(this.stack.buffer,this.frameptr+8+2*e)},put_prop:function(e,t,s){var r,i=this.find_prop(e,t);i&&(r=this.m.getUint8(i-1),this.ram[(this.version3?r>>5:64&r)?"setUint16":"setUint8"](i,s))},random:function(e){var t=this.xorshift_seed;return 1>e?(this.xorshift_seed=e,0):0===t?0|1+Math.random()*e:(t^=t<<13,t^=t>>17,this.xorshift_seed=t^=t<<5,1+(32767&t)%e)},remove_obj:function(e){var t,s,r,i=this.get_parent(e);if(0!==i)if(t=this.get_child(i),s=this.get_sibling(e),t===e)this.set_family(e,0,i,s);else{for(;r=this.get_sibling(t),r!==e;)t=r;this.set_family(e,0,0,0,t,s)}},restart:async function(){var t=this.ram,s=t.getUint8(0),r=3===s,o=r?2:8===s?8:4,a=t.getUint8(17),l=t.getUint16(10),p=4<s?t.getUint16(54):0,g=n.MemoryView(this.options.stack_len);t.setUint8Array(0,this.origram),t.setUint8(17,a),i(this,{stack:g,frameptr:0,frames:[],s:new Uint16Array(g.buffer,8),sp:0,l:[],undo:[],undo_len:0,glk_blocking_call:null,version:s,version3:r,pc:t.getUint16(6),properties:l,objects:l+(r?53:112),globals:t.getUint16(12),eof:(t.getUint16(26)||65536)*o,extension:p,extension_count:p?t.getUint16(p):0,addr_multipler:o,opcodes:e("./opcodes.js")(s)}),this.init_text(),await this.init_io(),await this.update_header()},restore:async function(){const e=this.Glk;let t=0;const s=await e.glk_fileref_create_by_prompt(1,2,0);if(s){const r=await e.glk_stream_open_file(s,2,0);if(r){const s=new Uint8Array(131072);await e.glk_get_buffer_stream(r,s),t=await this.restore_file(s.buffer),await e.glk_stream_close(r)}await e.glk_fileref_destroy(s)}return t},restore_file:async function(e,t){var n,o=this.ram,a=new r.Quetzal(e),l=a.memory,p=this.stack,g=o.getUint8(17),_=0,i=0;if(o.getUint16(2)!==a.release||o.getUint16(28)!==a.checksum)return 0;for(;6>_;)if(o.getUint8(18+_)!==a.serial[_++])return 0;if(_=0,o.setUint8Array(0,this.origram),a.compressed)for(;_<l.length;)n=l[_++],0===n?i+=1+l[_++]:o.setUint8(i,n^this.origram[i++]);else o.setUint8Array(0,l);for(o.setUint8(17,g),p.setUint8Array(0,a.stacks),this.frames=[],_=0;_<a.stacks.byteLength;)this.frameptr=_,this.frames.push(_),s(p,i=_+8,i+=2*(15&p.getUint8(_+3)),t),s(p,i,i+=2*p.getUint16(_+6),t),_=i;return this.frames.pop(),this.sp=p.getUint16(this.frameptr+6),this.make_stacks(),this.pc=a.pc,this.update_header(),this.version3&&(await this.split_window(0)),2},restore_undo:function(){if(0===this.undo.length)return 0;var e=this.undo.pop();return this.frameptr=e.frameptr,this.pc=e.pc,this.undo_len-=e.ram.byteLength+e.stack.byteLength,e.ram[17]=this.m.getUint8(17),this.ram.setUint8Array(0,e.ram),this.frames=e.frames,this.sp=e.sp,this.stack.setUint8Array(0,e.stack),this.make_stacks(),this.variable(e.var,2),1},ret:function(e){var t=this.stack,s=this.frameptr,r=16&t.getUint8(s+3)?-1:t.getUint8(s+4);this.pc=t.getUint32(s)>>8,s=this.frameptr=this.frames.pop(),this.make_stacks(),this.sp=t.getUint16(s+6),0<=r&&this.variable(r,e||0)},run:async function(){for(;!this.quit;){const e=this.pc;this.jit[e]||this.compile();const t=await this.jit[e](this);isNaN(t)||this.ret(t)}},save:async function(){const e=this.Glk;let t=0;const s=await e.glk_fileref_create_by_prompt(1,1,0);if(s){const r=await e.glk_stream_open_file(s,1,0);r&&(e.glk_put_buffer_stream(r,new Uint8Array(this.save_file(this.pc))),t=1,await e.glk_stream_close(r)),await e.glk_fileref_destroy(s)}return t},save_file:function(e,t){var o,i,a,l=this.m,g=new r.Quetzal,_=n.MemoryView(this.stack.buffer.slice()),u=0,c=this.frameptr;if(g.release=l.getUint16(2),g.serial=l.getUint8Array(18,6),g.checksum=l.getUint16(28),g.pc=e,t)g.memory=this.m.getUint8Array(0,this.staticmem);else{const e=[];for(g.compressed=1,o=0;o<this.staticmem;o++)a=l.getUint8(o)^this.origram[o],0===a?256==++u&&(e.push(0,255),u=0):(u&&(e.push(0,u-1),u=0),e.push(a));g.memory=e}if(_.setUint16(c+6,this.sp),p&&!t){const e=this.frames.slice();for(e.push(c),o=0;o<e.length;o++)c=e[o],s(_,i=c+8,i+=2*(15&_.getUint8(c+3))),s(_,i,i+=2*_.getUint16(c+6))}return g.stacks=_.getUint8Array(0,this.frameptr+8+2*(15&_.getUint8(c+3))+2*this.sp),g.write()},save_undo:function(e,t){var s;return this.undo_len>this.options.undo_len&&(s=this.undo.shift(),this.undo_len-=s.ram.byteLength+s.stack.byteLength),s={frameptr:this.frameptr,frames:this.frames.slice(),pc:e,ram:this.m.getUint8Array(0,this.staticmem),sp:this.sp,stack:this.stack.getUint8Array(0,this.s.byteOffset+2*this.sp),var:t},this.undo_len+=s.ram.byteLength+s.stack.byteLength,this.undo.push(s),1},scan_table:function(e,t,s,r){r=r||130;var i=128&r?"getUint16":"getUint8";for(r&=127,s=t+s*r;t<s;){if(this.m[i](t)===e)return t;t+=r}return 0},set_attr:function(e,t){var s=0|this.objects+(this.version3?9:14)*e+t/8;this.ram.setUint8(s,this.m.getUint8(s)|128>>t%8)},set_family:function(e,t,s,r,i,n){var o=this.ram,a=this.objects;this.version3?(o.setUint8(a+9*e+4,t),s&&o.setUint8(a+9*s+6,r),i&&o.setUint8(a+9*i+5,n)):(o.setUint16(a+14*e+6,t),s&&o.setUint16(a+14*s+10,r),i&&o.setUint16(a+14*i+8,n))},test:function(e,t){return(e&t)===t},test_attr:function(e,t){return 128&this.m.getUint8(0|this.objects+(this.version3?9:14)*e+t/8)<<t%8},variable:function(e,t){var s,r=t!==void 0;if(0===e){if(r)this.s[this.sp++]=t;else return this.s[--this.sp];}else if(15>--e){if(r)this.l[e]=t;else return this.l[e];}else if(s=this.globals+2*(e-15),r)this.ram.setUint16(s,t);else return this.m.getUint16(s);return t},U2S:o,S2U:a}},{"../common/file.js":2,"../common/utils.js":3,"./opcodes.js":7}],9:[function(s,r){r.exports={init_text:function(){var e=this,s=this.m,r=4<this.version&&s.getUint16(52),i=this.extension_table(3),n=i&&s.getUint8(i++);this.abbr_addr=s.getUint16(24),function(t){for(var s=[[],[],[]],r=0;78>r;)s[0|r/26][r%26]=t[r++];s[2][1]=13,e.alphabets=s}(r?s.getUint8Array(r,78):this.text_to_zscii("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ \r0123456789.,!?_#'\"/\\-:()",1)),function(s){for(var r={13:"\r"},n={13:13},o=0;o<s.length;)r[155+o]=t(s[o]),n[s[o]]=155+o++;for(o=32;127>o;)r[o]=t(o),n[o]=o++;e.unicode_table=r,e.reverse_unicode_table=n}(i?s.getUint16Array(i,n):this.text_to_zscii(unescape("%E4%F6%FC%C4%D6%DC%DF%BB%AB%EB%EF%FF%CB%CF%E1%E9%ED%F3%FA%FD%C1%C9%CD%D3%DA%DD%E0%E8%EC%F2%F9%C0%C8%CC%D2%D9%E2%EA%EE%F4%FB%C2%CA%CE%D4%DB%E5%C5%F8%D8%E3%F1%F5%C3%D1%D5%E6%C6%E7%C7%FE%F0%DE%D0%A3%u0153%u0152%A1%BF"),1)),this.dictionaries={},this.dict=s.getUint16(8),this.parse_dict(this.dict)},decode:function(e,t){var s,r,n,o=this.m,a=e,l=[],p=0,i=0,g=[],_=[],u=0;if(this.jit[e])return this.jit[e];for(t=t?t+e:this.eof;e<t&&(s=o.getUint16(e),e+=2,l.push(31&s>>10,31&s>>5,31&s),!(32768&s)););for(;p<l.length;)r=l[p++],0===r?g.push(32):4>r?(n=1,g.push(-1),_.push("\uE000+this.abbr("+(32*(r-1)+l[p++])+")+\uE000")):6>r?i=r:2==i&&6===r?p+1<l.length&&g.push(l[p++]<<5|l[p++]):32>r&&g.push(this.alphabets[i][r-6]),i=4>i?0:i-3,0==p%3&&(p+=u,u=0);return g=this.zscii_to_text(g,_),n&&(g={toString:Function("return\""+g.replace(/\\/g,"\\\\").replace(/"/g,"\\\"").replace(/\r/g,"\\r").replace(/\uE000/g,"\"")+"\"").bind(this)}),a>=this.staticmem&&(this.jit[a]=g),g},encode:function(e){for(var t,s,r=this.alphabets,n=[],o=this.version3?6:9,a=0,i=[];n.length<o;)t=e[a++],32===t?n.push(0):0<=(s=r[0].indexOf(t))?n.push(s+6):0<=(s=r[1].indexOf(t))?n.push(4,s+6):0<=(s=r[2].indexOf(t))?n.push(5,s+6):void 0===t?n.push(5):n.push(5,6,t>>5,31&t);for(n.length=o,a=0;a<o;)i.push(n[a++]<<2|n[a]>>3,(7&n[a++])<<5|n[a++]);return i[i.length-2]|=128,i},zscii_to_text:function(e,t){for(var s,r=0,i=e.length,n=0,o="";r<i;)s=e[r++],-1===s&&(o+=t[n++]),(s=this.unicode_table[s])&&(o+=s);return o},text_to_zscii:function(e,t){for(var s,r=[],n=0,i=e.length;n<i;)s=e.charCodeAt(n++),t||(s=this.reverse_unicode_table[s]||63),r.push(s);return r},parse_dict:function(e){var t,s,r=this.m,i=e,n={},o=r.getUint8(e++);for(n.separators=Array.prototype.slice.call(r.getUint8Array(e,o)),e+=o,t=r.getUint8(e++),s=e+2+t*r.getUint16(e),e+=2;e<s;)n[Array.prototype.toString.call(r.getUint8Array(e,this.version3?4:6))]=e,e+=t;return this.dictionaries[i]=n,n},abbr:function(e){return this.decode(2*this.m.getUint16(this.abbr_addr+2*e))},tokenise:function(t,s,r,n){r=r||this.dict,r=this.dictionaries[r]||this.parse_dict(r);var o,a,l,p,g=this.m,_=this.ram,u=1e3,c=1,i=r.separators,d=[],m=0;for(4<this.version&&(u=g.getUint8(t+c++)+2);c<u&&(o=g.getUint8(t+c),0!==o);)32===o||0<=i.indexOf(o)?(32!==o&&d.push([[o],c]),a=null):(a||(d.push([[],c]),a=d[d.length-1][0]),a.push(o)),c++;for(l=e(d.length,g.getUint8(s));m<l;)p=r[""+this.encode(d[m][0])],(!n||p)&&(_.setUint16(s+2+4*m,p||0),_.setUint8(s+4+4*m,d[m][0].length),_.setUint8(s+5+4*m,d[m][1])),m++;_.setUint8(s+1,m)}}},{}]},{},[4])(4)});

